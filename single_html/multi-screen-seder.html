<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Passover Seder AI</title>
    <style>
        body {
            font-family: 'Arial Hebrew', Arial, sans-serif;
            background-color: #f5f0e5;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            text-align: center;
        }
        
        .header {
            background-color: #8d6b4a;
            color: white;
            padding: 10px;
            text-align: center;
        }
        
        .main-container {
            display: flex;
            flex-direction: column;
            flex: 1;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .character-face {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            margin: 0 auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 100px;
            color: white;
            position: relative;
            overflow: hidden;
        }
        
        .face-wise {
            background-color: #3a6ea5;
        }
        
        .face-wicked {
            background-color: #993333;
        }
        
        .face-simple {
            background-color: #339966;
        }
        
        .speaking {
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .character-name {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .character-speech {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            min-height: 100px;
            width: 80%;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        .controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 20px;
            width: 80%;
        }
        
        .section-selector {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            font-size: 16px;
        }
        
        .voice-button {
            background-color: #8d6b4a;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 30px;
            font-size: 18px;
            cursor: pointer;
            margin: 10px 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .voice-button:hover {
            background-color: #725639;
        }
        
        .voice-button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        
        .voice-button i {
            margin-right: 10px;
        }
        
        .status {
            margin-top: 10px;
            font-style: italic;
            color: #666;
        }
        
        .actions {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }
        
        .action-button {
            background-color: #4a768d;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .action-button:hover {
            background-color: #395e6f;
        }
        
        .hidden {
            display: none;
        }
        
        .haggadah-text {
            background-color: #f9f5eb;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            margin: 15px 0;
            max-height: 150px;
            overflow-y: auto;
            width: 80%;
            text-align: left;
        }
        
        .hebrew {
            font-family: 'Arial Hebrew', 'Times New Roman', serif;
            direction: rtl;
            font-size: 1.2em;
        }
        
        /* Animation for listening */
        .listening {
            position: relative;
        }
        
        .listening::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: 50%;
            border: 3px solid red;
            animation: listening-pulse 1.5s infinite;
        }
        
        @keyframes listening-pulse {
            0% { transform: scale(1); opacity: 1; }
            100% { transform: scale(1.3); opacity: 0; }
        }
        
        /* Loading spinner */
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            margin-left: 10px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Passover Seder AI</h1>
    </div>
    
    <div class="main-container">
        <div id="setup-screen">
            <h2>Choose Your Character</h2>
            <div style="display: flex; justify-content: center; gap: 20px; margin: 30px 0;">
                <div onclick="selectCharacter('wise')" style="cursor: pointer; padding: 20px; border: 1px solid #ccc; border-radius: 10px;">
                    <div class="character-face face-wise"></div>
                    <div class="character-name">Wise Son</div>
                    <p>Knowledgeable, thoughtful, references Jewish texts</p>
                </div>
                <div onclick="selectCharacter('wicked')" style="cursor: pointer; padding: 20px; border: 1px solid #ccc; border-radius: 10px;">
                    <div class="character-face face-wicked"></div>
                    <div class="character-name">Wicked Son</div>
                    <p>Skeptical, challenging, provocative questions</p>
                </div>
                <div onclick="selectCharacter('simple')" style="cursor: pointer; padding: 20px; border: 1px solid #ccc; border-radius: 10px;">
                    <div class="character-face face-simple"></div>
                    <div class="character-name">Simple Son</div>
                    <p>Earnest, straightforward, expresses wonder</p>
                </div>
            </div>
        </div>
        
        <div id="character-screen" class="hidden">
            <div id="character-face" class="character-face">
                <span id="face-emoji"></span>
            </div>
            <div id="character-name" class="character-name"></div>
            
            <div class="haggadah-text" id="haggadah-text">
                <p>Waiting for the Seder to begin...</p>
            </div>
            
            <div class="character-speech" id="character-speech">
                I'm ready for the Passover Seder!
            </div>
            
            <div class="controls">
                <select class="section-selector" id="section-selector">
                    <option value="">-- Select Haggadah Section --</option>
                    <option value="kadesh">Kadesh - Sanctification (拽砖)</option>
                    <option value="urchatz">Urchatz - Washing Hands (专抓)</option>
                    <option value="karpas">Karpas - Vegetable in Salt Water (专驻住)</option>
                    <option value="yachatz">Yachatz - Breaking the Middle Matzah (抓)</option>
                    <option value="maggid">Maggid - Telling the Story ()</option>
                    <option value="questions">Four Questions ( 砖转)</option>
                    <option value="sons">Four Sons (专注 )</option>
                    <option value="plagues">Ten Plagues (注砖专 转)</option>
                    <option value="dayenu">Dayenu ()</option>
                    <option value="matzah">Motzi Matzah - Blessing over Matzah (爪 爪)</option>
                    <option value="maror">Maror - Bitter Herbs (专专)</option>
                    <option value="meal">Shulchan Orech - Festive Meal (砖 注专)</option>
                    <option value="afikoman">Tzafun - Eating the Afikoman (爪驻)</option>
                    <option value="nirtzah">Nirtzah - Conclusion (专爪)</option>
                </select>
                
                <button id="listen-button" class="voice-button">
                    <i></i> Listen for Voice Input
                </button>
                
                <button id="speak-button" class="voice-button">
                    <i></i> Speak My Response
                </button>
                
                <div id="status" class="status">Ready to participate in the Seder</div>
                
                <div class="actions">
                    <button id="sync-button" class="action-button">Sync with Seder</button>
                    <button id="reset-button" class="action-button">Reset</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let selectedCharacter = null;
        let currentSection = null;
        let lastSpeaker = null;
        let previousResponse = null;
        let recognition = null;
        let synth = window.speechSynthesis;
        let characterVoices = {};
        let isListening = false;
        
        // Character configuration
        const characters = {
            wise: {
                name: "Wise Son (Chacham)",
                emoji: "",
                faceClass: "face-wise",
                prompt: "Knowledgeable about Jewish traditions. Asks thoughtful questions. References history and Jewish texts. Intellectual but warm tone.",
                voiceParams: { rate: 0.9, pitch: 1.1 } // Thoughtful, measured voice
            },
            wicked: {
                name: "Wicked Son (Rasha)",
                emoji: "",
                faceClass: "face-wicked",
                prompt: "Skeptical and challenging. Says 'Why do YOU do this?' Dismissive of traditions. Provocative questions. Sarcastic but witty tone.",
                voiceParams: { rate: 1.1, pitch: 0.9 } // Slightly faster, lower pitch for skepticism
            },
            simple: {
                name: "Simple Son (Tam)",
                emoji: "",
                faceClass: "face-simple",
                prompt: "Earnest and straightforward. Asks basic questions like 'What is this?' Expresses wonder. Warm tone. Shares personal reflections.",
                voiceParams: { rate: 1, pitch: 1.2 } // Higher pitch, friendly voice
            }
        };
        
        // Haggadah sections with descriptions
        const sections = {
            kadesh: "Blessing the first cup of wine to sanctify the holiday.",
            urchatz: "Washing hands without a blessing.",
            karpas: "Dipping vegetable in salt water (tears of slavery).",
            yachatz: "Breaking the middle matzah and hiding half as the afikoman.",
            maggid: "Beginning the telling of the Passover story.",
            questions: "Why is this night different from all other nights?",
            sons: "The Torah speaks of four sons: wise, wicked, simple, and one who doesn't know how to ask.",
            plagues: "The ten plagues that God brought upon Egypt.",
            dayenu: "It would have been enough for us.",
            matzah: "Blessing and eating the matzah (bread of affliction).",
            maror: "Eating bitter herbs to taste the bitterness of slavery.",
            meal: "The festive meal.",
            afikoman: "Finding and eating the hidden afikoman.",
            nirtzah: "Conclusion - Next year in Jerusalem!"
        };
        
        // Set up speech recognition
        function setupSpeechRecognition() {
            if ('webkitSpeechRecognition' in window) {
                recognition = new webkitSpeechRecognition();
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.lang = 'en-US';
                
                recognition.onstart = function() {
                    isListening = true;
                    document.getElementById('character-face').classList.add('listening');
                    document.getElementById('status').textContent = "Listening...";
                    document.getElementById('listen-button').disabled = true;
                };
                
                recognition.onresult = function(event) {
                    const transcript = event.results[0][0].transcript;
                    handleVoiceInput(transcript);
                };
                
                recognition.onend = function() {
                    isListening = false;
                    document.getElementById('character-face').classList.remove('listening');
                    document.getElementById('status').textContent = "Voice input received";
                    document.getElementById('listen-button').disabled = false;
                };
                
                recognition.onerror = function(event) {
                    isListening = false;
                    document.getElementById('character-face').classList.remove('listening');
                    document.getElementById('status').textContent = "Error: " + event.error;
                    document.getElementById('listen-button').disabled = false;
                };
            } else {
                alert("Speech recognition is not supported in your browser. Try using Chrome.");
                document.getElementById('listen-button').disabled = true;
            }
        }
        
        // Set up text-to-speech
        function setupTextToSpeech() {
            if ('speechSynthesis' in window) {
                // Wait for voices to be loaded
                synth.onvoiceschanged = function() {
                    const voices = synth.getVoices();
                    
                    // Try to find good voices for each character
                    let maleVoice = voices.find(voice => 
                        voice.name.includes('Male') || 
                        voice.name.includes('David') || 
                        voice.name.includes('Google UK English Male'));
                    
                    let femaleVoice = voices.find(voice => 
                        voice.name.includes('Female') || 
                        voice.name.includes('Samantha') || 
                        voice.name.includes('Google UK English Female'));
                    
                    // Fallback to any available voice
                    const defaultVoice = voices.find(voice => voice.lang.includes('en')) || voices[0];
                    
                    characterVoices = {
                        wise: maleVoice || defaultVoice,
                        wicked: maleVoice || defaultVoice,
                        simple: femaleVoice || defaultVoice
                    };
                };
                
                synth.onvoiceschanged();
            } else {
                alert("Text-to-speech is not supported in your browser. Try using Chrome.");
                document.getElementById('speak-button').disabled = true;
            }
        }
        
        // Handle voice input
        function handleVoiceInput(transcript) {
            document.getElementById('haggadah-text').textContent = transcript;
            document.getElementById('status').textContent = "Processing voice input...";
            
            // Save to localStorage for other screens
            localStorage.setItem('sederHaggadahText', transcript);
            localStorage.setItem('sederLastSpeaker', 'human');
            localStorage.setItem('sederTimestamp', Date.now().toString());
            
            // Get AI response
            getAIResponse(selectedCharacter, currentSection, transcript);
        }
        
        // Get AI response from Ollama
        function getAIResponse(character, section, previousText) {
            const characterDetails = characters[character];
            if (!characterDetails) return;
            
            const systemPrompt = "You're participating in a Passover Seder roleplay. Respond as the character I specify:";
            
            let prompt = `${systemPrompt}\n\n${characterDetails.prompt}\n\nCurrent section: ${sections[section] || section || "Passover Seder"}`;
            
            if (previousText) {
                prompt += `\n\nHuman said: "${previousText}"`;
            }
            
            prompt += `\n\nRespond as the ${characterDetails.name} would in 2-4 sentences:`;
            
            document.getElementById('status').textContent = "Thinking...";
            document.getElementById('character-face').classList.add('speaking');
            
            // Mock API call (replace with actual Ollama API call in production)
            mockOllamaApiCall(prompt)
                .then(response => {
                    document.getElementById('character-speech').textContent = response;
                    document.getElementById('status').textContent = "Response received";
                    document.getElementById('character-face').classList.remove('speaking');
                    
                    // Save response to localStorage for other screens
                    localStorage.setItem('sederPreviousResponse', response);
                    localStorage.setItem('sederLastSpeaker', character);
                    localStorage.setItem('sederTimestamp', Date.now().toString());
                    
                    // Auto-speak if button is available
                    if (document.getElementById('speak-button').disabled === false) {
                        speakResponse(response);
                    }
                })
                .catch(error => {
                    document.getElementById('status').textContent = "Error: " + error.message;
                    document.getElementById('character-face').classList.remove('speaking');
                });
        }
        
        // Mock Ollama API call (replace with actual API call)
        function mockOllamaApiCall(prompt) {
            return new Promise((resolve, reject) => {
                // In a real implementation, you would call the Ollama API here
                // For demo purposes, we'll return character-specific mock responses
                
                setTimeout(() => {
                    // Sample responses based on current section and character
                    const section = currentSection || "general";
                    const character = selectedCharacter;
                    
                    const responses = {
                        wise: {
                            general: "The Passover Seder connects us to thousands of years of Jewish history. Each ritual element serves as a symbolic reminder of our ancestors' journey from slavery to freedom. As Maimonides taught, we must see ourselves as if we personally left Egypt.",
                            kadesh: "The blessing over wine sanctifies not just this cup, but the entire Seder experience. Wine represents both joy and sacrifice - its red color reminds us of the blood of the paschal lamb. The four cups correspond to the four expressions of redemption in Exodus 6:6-7.",
                            questions: "These questions brilliantly serve as pedagogical tools, encouraging curiosity and engagement. By questioning the unusual rituals, we fulfill the mitzvah of telling the story to our children. The structure of question and answer mirrors the Talmudic method of learning through inquiry."
                        },
                        wicked: {
                            general: "Why do YOU insist on these elaborate rituals year after year? It seems like an awful lot of symbolism and procedure for an event that historians debate even happened as described. I find it interesting how people cling to tradition while rarely questioning its historical accuracy.",
                            kadesh: "So YOU start with alcohol? Convenient how religious ceremonies often involve intoxicating substances. Four cups seems excessive - was one cup not symbolic enough? I wonder how many people actually understand what they're celebrating versus just going through motions.",
                            questions: "These questions are clearly leading the witness, don't you think? They're designed to elicit specific answers rather than encourage genuine critical thinking. If YOU really wanted intellectual honesty, you'd also question whether these events happened exactly as described."
                        },
                        simple: {
                            general: "What are all these different foods and cups for? Everything looks special and different tonight! I like how we're all together telling stories about our past. It makes me feel connected to something bigger than myself.",
                            kadesh: "Why is the wine so important? It tastes sweet! I notice everyone seems more happy and excited when we lift our cups together. Is this how our ancestors started their special meal too?",
                            questions: "I've always wondered why we do these unusual things tonight! The matzah is so flat and the herbs taste so bitter. It's interesting how food can tell a story - I can almost imagine what it felt like to leave Egypt in a hurry."
                        }
                    };
                    
                    // Return the appropriate response or a default one
                    const response = responses[character]?.[section] || 
                                    responses[character]?.general || 
                                    "I'm participating in the Passover Seder and reflecting on its meaning.";
                    
                    resolve(response);
                }, 2000); // Simulate API delay
            });
        }
        
        // Speak the response using text-to-speech
        function speakResponse(text) {
            if (!synth) return;
            
            // Cancel any ongoing speech
            synth.cancel();
            
            const utterance = new SpeechSynthesisUtterance(text);
            const characterVoice = characterVoices[selectedCharacter];
            const voiceParams = characters[selectedCharacter].voiceParams;
            
            if (characterVoice) utterance.voice = characterVoice;
            if (voiceParams) {
                utterance.rate = voiceParams.rate;
                utterance.pitch = voiceParams.pitch;
            }
            
            utterance.onstart = function() {
                document.getElementById('character-face').classList.add('speaking');
                document.getElementById('speak-button').disabled = true;
            };
            
            utterance.onend = function() {
                document.getElementById('character-face').classList.remove('speaking');
                document.getElementById('speak-button').disabled = false;
            };
            
            synth.speak(utterance);
        }
        
        // Check for updates from other screens
        function checkForUpdates() {
            const timestamp = localStorage.getItem('sederTimestamp');
            if (!timestamp) return;
            
            // Only process if it's a new update (within last 5 seconds)
            const now = Date.now();
            const updateTime = parseInt(timestamp);
            
            if (now - updateTime < 5000) {
                const lastSpeaker = localStorage.getItem('sederLastSpeaker');
                
                // Only update if it wasn't us speaking
                if (lastSpeaker && lastSpeaker !== selectedCharacter) {
                    const haggadahText = localStorage.getItem('sederHaggadahText');
                    const previousResponse = localStorage.getItem('sederPreviousResponse');
                    
                    // Update our display
                    if (lastSpeaker === 'human' && haggadahText) {
                        document.getElementById('haggadah-text').textContent = haggadahText;
                        
                        // If it's our turn to respond (randomly)
                        const characters = ['wise', 'wicked', 'simple'];
                        const otherCharacters = characters.filter(c => c !== selectedCharacter);
                        
                        // 1 in 3 chance this character responds
                        if (Math.random() < 0.33) {
                            // Get AI response
                            getAIResponse(selectedCharacter, currentSection, haggadahText);
                        }
                    } else if (previousResponse) {
                        // Show what another character said
                        const speakerName = characters[lastSpeaker]?.name || "Another participant";
                        document.getElementById('character-speech').textContent = 
                            `${speakerName} said: "${previousResponse}"`;
                    }
                }
            }
        }
        
        // Select character
        function selectCharacter(character) {
            if (!characters[character]) return;
            
            selectedCharacter = character;
            const characterInfo = characters[character];
            
            // Update UI
            document.getElementById('setup-screen').classList.add('hidden');
            document.getElementById('character-screen').classList.remove('hidden');
            
            document.getElementById('face-emoji').textContent = characterInfo.emoji;
            document.getElementById('character-name').textContent = characterInfo.name;
            document.getElementById('character-face').className = 
                `character-face ${characterInfo.faceClass}`;
            
            // Set up voice capabilities
            setupSpeechRecognition();
            setupTextToSpeech();
            
            // Start checking for updates
            setInterval(checkForUpdates, 2000);
        }
        
        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Section selector
            document.getElementById('section-selector').addEventListener('change', function() {
                currentSection = this.value;
                if (currentSection) {
                    document.getElementById('haggadah-text').textContent = sections[currentSection] || currentSection;
                    
                    // Save to localStorage
                    localStorage.setItem('sederCurrentSection', currentSection);
                    localStorage.setItem('sederHaggadahText', sections[currentSection] || currentSection);
                }
            });
            
            // Listen button
            document.getElementById('listen-button').addEventListener('click', function() {
                if (recognition && !isListening) {
                    recognition.start();
                }
            });
            
            // Speak button
            document.getElementById('speak-button').addEventListener('click', function() {
                const text = document.getElementById('character-speech').textContent;
                speakResponse(text);
            });
            
            // Sync button
            document.getElementById('sync-button').addEventListener('click', function() {
                const sectionFromStorage = localStorage.getItem('sederCurrentSection');
                if (sectionFromStorage) {
                    currentSection = sectionFromStorage;
                    document.getElementById('section-selector').value = sectionFromStorage;
                    
                    const haggadahText = localStorage.getItem('sederHaggadahText');
                    if (haggadahText) {
                        document.getElementById('haggadah-text').textContent = haggadahText;
                    }
                }
                
                document.getElementById('status').textContent = "Synced with Seder";
            });
            
            // Reset button
            document.getElementById('reset-button').addEventListener('click', function() {
                if (confirm("Reset this character's view? This won't affect other screens.")) {
                    document.getElementById('character-speech').textContent = "I'm ready for the Passover Seder!";
                    document.getElementById('haggadah-text').textContent = "Waiting for the Seder to begin...";
                    document.getElementById('section-selector').value = "";
                    currentSection = null;
                    document.getElementById('status').textContent = "Reset complete";
                }
            });
        });
    </script>
</body>
</html>
